---
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { data as site } from '../../data/siteData';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => +b.data.date - +a.data.date);

const title = `Blog – Conseils & Actus à Toulouse | ${site.name}`;
const description = "Guides, démarches et retours d’expérience autour de l’enlèvement d’épaves à Toulouse et en Occitanie.";
const jsonld = {
  '@context': 'https://schema.org',
  '@type': 'Blog',
  name: title,
  url: '/blog/',
  inLanguage: 'fr-FR',
  publisher: { '@type': 'Organization', name: site.name, telephone: site.phoneCompact },
};

const featured = posts[0];
const others = posts.slice(1);
---

<Layout title={title} description={description} ogImage="/images/epaviste-hero.png" jsonld={jsonld} lang="fr">
  <section id="blog-index" class="relative mx-auto max-w-6xl px-6 py-16">
    <!-- décor discret -->
    <div class="pointer-events-none absolute inset-x-0 top-0 -z-10 h-28 bg-gradient-to-b from-emerald-100/60 to-transparent opacity-70"></div>

    <!-- Header + retour accueil -->
    <div class="mb-8 flex flex-wrap items-end justify-between gap-4">
      <div>
        <a href="/" class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 transition hover:-translate-y-0.5 hover:text-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Retour à l’accueil
        </a>
        <h1 class="mt-3 text-3xl font-bold tracking-tight">Blog</h1>
        <p class="mt-2 text-zinc-600">{description}</p>
      </div>

      {posts.length > 0 && (
        <a href="/blog/" class="inline-flex items-center gap-2 rounded-2xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500">
          Tous les articles
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 17L17 7M17 7H9M17 7v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      )}
    </div>

    {posts.length === 0 ? (
      <p class="rounded-2xl bg-white/70 p-6 text-gray-600 ring-1 ring-gray-200">
        Les articles arrivent bientôt.
      </p>
    ) : (
      <>
        <!-- Featured (le plus récent) -->
        <div class="mb-8 grid gap-6 lg:grid-cols-3">
          {featured && (
            <div class="lg:col-span-2">
              <div class="post-card reveal group relative overflow-hidden rounded-2xl transition duration-300 hover:-translate-y-1 hover:shadow-xl"
                   style="--delay:0ms">
                <!-- bordure dégradée -->
                <div class="pointer-events-none absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask-composite: xor; mask-composite: exclude; padding:1px;
                            background:linear-gradient(120deg, rgba(16,185,129,.5), rgba(16,185,129,.12), rgba(16,185,129,.5));"></div>
                <!-- spotlight -->
                <div class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="background: radial-gradient(420px circle at var(--x,50%) var(--y,50%), rgba(16,185,129,.08), transparent 40%);"></div>

                <BlogCard post={featured} />
              </div>
            </div>
          )}

          <!-- Petit encart latéral (optionnel) -->
          <aside class="reveal rounded-2xl bg-white p-6 ring-1 ring-gray-200" style="--delay:80ms">
            <h3 class="font-semibold">À propos du blog</h3>
            <p class="mt-2 text-sm text-gray-600">Conseils pratiques, démarches, et retours d’expérience pour l’enlèvement d’épaves à Toulouse et en Occitanie.</p>
            <a href="/" class="mt-4 inline-flex items-center gap-2 text-sm font-medium text-emerald-700 underline decoration-emerald-300 underline-offset-4 hover:text-emerald-800">
              ← Retour à l’accueil
            </a>
          </aside>
        </div>

        <!-- Le reste des articles -->
        {others.length > 0 && (
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {others.map((post, i) => (
              <div class="post-card reveal group relative overflow-hidden rounded-2xl transition duration-300 hover:-translate-y-1 hover:shadow-xl"
                   style={`--delay:${(i + 1) * 80}ms`}>
                <!-- bordure dégradée -->
                <div class="pointer-events-none absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask-composite: xor; mask-composite: exclude; padding:1px;
                            background:linear-gradient(120deg, rgba(16,185,129,.5), rgba(16,185,129,.12), rgba(16,185,129,.5));"></div>
                <!-- spotlight -->
                <div class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="background: radial-gradient(360px circle at var(--x,50%) var(--y,50%), rgba(16,185,129,.08), transparent 40%);"></div>

                <BlogCard post={post} />
              </div>
            ))}
          </div>
        )}
      </>
    )}
  </section>
</Layout>

<style is:global>
/* reveal au scroll + délai via --delay */
.reveal { opacity: 0; transform: translateY(8px); transition: opacity .45s ease, transform .45s ease; transition-delay: var(--delay, 0ms); }
.reveal.is-inview { opacity: 1; transform: translateY(0); }

@media (prefers-reduced-motion: reduce) {
  .reveal { opacity: 1; transform: none; transition: none; }
  .post-card { transition: none !important; }
}
</style>

<script>
  // Reveal au scroll
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) { e.target.classList.add('is-inview'); io.unobserve(e.target); }
    });
  }, { threshold: 0.18 });
  document.querySelectorAll('.reveal').forEach(el => io.observe(el));

  // Spotlight suivant la souris
  document.querySelectorAll('.post-card').forEach((card) => {
    card.addEventListener('mousemove', (e) => {
      const r = card.getBoundingClientRect();
      const x = ((e.clientX - r.left) / r.width) * 100;
      const y = ((e.clientY - r.top) / r.height) * 100;
      card.style.setProperty('--x', x + '%');
      card.style.setProperty('--y', y + '%');
    });
    card.addEventListener('mouseleave', () => {
      card.style.removeProperty('--x'); card.style.removeProperty('--y');
    });
  });
</script>
