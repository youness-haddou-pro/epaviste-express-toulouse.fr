---
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';
import { data as site } from '../../data/siteData';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => +b.data.date - +a.data.date);

const title = `Blog – Conseils & Actus à Toulouse | ${site.name}`;
const description = "Guides, démarches et retours d’expérience autour de l’enlèvement d’épaves à Toulouse et en Occitanie.";
const jsonld = {
  '@context': 'https://schema.org',
  '@type': 'Blog',
  name: title,
  url: '/blog/',
  inLanguage: 'fr-FR',
  publisher: { '@type': 'Organization', name: site.name, telephone: site.phoneCompact },
};

const featured = posts[0];
const others = posts.slice(1);
---

<Layout title={title} description={description} ogImage="/images/epaviste-hero.png" jsonld={jsonld} lang="fr">
  <section id="blog-index" class="relative mx-auto max-w-6xl px-6 py-16">
    <!-- décor discret -->
    <div class="pointer-events-none absolute inset-x-0 top-0 -z-10 h-28 bg-gradient-to-b from-emerald-100/60 to-transparent opacity-70"></div>

    <!-- Header + retour accueil -->
    <div class="mb-8 flex flex-wrap items-end justify-between gap-4">
      <div>
        <a href="/" class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 transition hover:-translate-y-0.5 hover:text-gray-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            class="h-4 w-4"
            aria-hidden="true"
            focusable="false"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M15 18l-6-6 6-6" />
          </svg>
          Retour à l’accueil
        </a>
        <h1 class="mt-3 text-3xl font-bold tracking-tight">Blog</h1>
        <p class="mt-2 text-zinc-600">{description}</p>

        <!-- Filtre actif (chip) -->
        <div id="active-filter"
             class="hidden mt-4 inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-sm text-emerald-800 ring-1 ring-emerald-200">
          <span id="active-filter-label"></span>
          <a href="/blog/" class="rounded-full bg-white/70 px-2 py-0.5 text-emerald-900 ring-1 ring-emerald-200 hover:bg-white">
            Effacer
          </a>
        </div>
      </div>

      {posts.length > 0 && (
        <a href="/blog/" class="inline-flex items-center gap-2 rounded-2xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500">
          Tous les articles
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            class="h-4 w-4"
            aria-hidden="true"
            focusable="false"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M7 17L17 7M17 7H9M17 7v8" />
          </svg>
        </a>
      )}
    </div>

    {posts.length === 0 ? (
      <p class="rounded-2xl bg-white/70 p-6 text-gray-600 ring-1 ring-gray-200">
        Les articles arrivent bientôt.
      </p>
    ) : (
      <>
        <!-- Featured (le plus récent) -->
        <div class="mb-8 grid gap-6 lg:grid-cols-3">
          {featured && (
            <div class="lg:col-span-2">
              <div
                class="post-card reveal group relative overflow-hidden rounded-2xl transition duration-300 hover:-translate-y-1 hover:shadow-xl"
                style="--delay:0ms"
                data-ville={featured.data.ville ?? ''}
                data-tags={(featured.data.tags ?? []).join(',')}
              >
                <!-- bordure dégradée -->
                <div class="pointer-events-none absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask-composite: xor; mask-composite: exclude; padding:1px;
                            background:linear-gradient(120deg, rgba(16,185,129,.5), rgba(16,185,129,.12), rgba(16,185,129,.5));"></div>
                <!-- spotlight -->
                <div class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="background: radial-gradient(420px circle at var(--x,50%) var(--y,50%), rgba(16,185,129,.08), transparent 40%);"></div>

                <BlogCard post={featured} />
              </div>
            </div>
          )}

          <!-- Petit encart latéral (optionnel) -->
          <aside class="reveal rounded-2xl bg-white p-6 ring-1 ring-gray-200" style="--delay:80ms">
            <h3 class="font-semibold">À propos du blog</h3>
            <p class="mt-2 text-sm text-gray-600">Conseils pratiques, démarches, et retours d’expérience pour l’enlèvement d’épaves à Toulouse et en Occitanie.</p>
            <a href="/" class="mt-4 inline-flex items-center gap-2 text-sm font-medium text-emerald-700 underline decoration-emerald-300 underline-offset-4 hover:text-emerald-800">
              ← Retour à l’accueil
            </a>
          </aside>
        </div>

        <!-- Le reste des articles -->
        {others.length > 0 && (
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {others.map((post, i) => (
              <div
                class="post-card reveal group relative overflow-hidden rounded-2xl transition duration-300 hover:-translate-y-1 hover:shadow-xl"
                style={`--delay:${(i + 1) * 80}ms`}
                data-ville={post.data.ville ?? ''}
                data-tags={(post.data.tags ?? []).join(',')}
              >
                <!-- bordure dégradée -->
                <div class="pointer-events-none absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
                            -webkit-mask-composite: xor; mask-composite: exclude; padding:1px;
                            background:linear-gradient(120deg, rgba(16,185,129,.5), rgba(16,185,129,.12), rgba(16,185,129,.5));"></div>
                <!-- spotlight -->
                <div class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"
                     style="background: radial-gradient(360px circle at var(--x,50%) var(--y,50%), rgba(16,185,129,.08), transparent 40%);"></div>

                <BlogCard post={post} />
              </div>
            ))}
          </div>
        )}
      </>
    )}

    <!-- État vide -->
    <p id="empty-state" class="hidden mt-8 rounded-2xl bg-white/70 p-6 text-gray-600 ring-1 ring-gray-200">
      Aucun article ne correspond à <strong id="empty-city"></strong>.
    </p>
  </section>
</Layout>

<style is:global>
/* reveal au scroll + délai via --delay */
.reveal { opacity: 0; transform: translateY(8px); transition: opacity .45s ease, transform .45s ease; transition-delay: var(--delay, 0ms); }
.reveal.is-inview { opacity: 1; transform: translateY(0); }

@media (prefers-reduced-motion: reduce) {
  .reveal { opacity: 1; transform: none; transition: none; }
  .post-card { transition: none !important; }
}
</style>

<script>
  // Reveal au scroll
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) { e.target.classList.add('is-inview'); io.unobserve(e.target); }
    });
  }, { threshold: 0.18 });
  document.querySelectorAll('.reveal').forEach(el => io.observe(el));

  // Spotlight suivant la souris
  document.querySelectorAll('.post-card').forEach((card) => {
    card.addEventListener('mousemove', (e) => {
      const r = card.getBoundingClientRect();
      const x = ((e.clientX - r.left) / r.width) * 100;
      const y = ((e.clientY - r.top) / r.height) * 100;
      card.style.setProperty('--x', x + '%');
      card.style.setProperty('--y', y + '%');
    });
    card.addEventListener('mouseleave', () => {
      card.style.removeProperty('--x'); card.style.removeProperty('--y');
    });
  });

  // --- Filtre ?ville= (Toulouse, Colomiers, etc.) ---
  (function () {
    const params = new URLSearchParams(location.search);
    const villeParam = params.get('ville');
    if (!villeParam) return;

    // Normalisation (sans accents, lowercase)
    const normalize = (s) =>
      (s || '')
        .toString()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .toLowerCase()
        .trim();

    const nv = normalize(villeParam);

    // Groupes métropolitains : étends cette liste si besoin
    const metro = {
      // Toulouse Métropole & proches
      toulouse: [
        'toulouse', 'colomiers', 'blagnac', 'tournefeuille', 'labege', 'balma',
        'muret', 'cugnaux', 'ramonville', 'st-orens', 'saint-orens', 'l-union',
        'castanet', 'portet', 'plaisance-du-touch'
      ],
      colomiers: [
        'colomiers', 'toulouse', 'blagnac', 'tournefeuille', 'cugnaux', 'plaisance-du-touch'
      ],
    };

    // Si la ville demandée appartient à un groupe, on prend tout le groupe.
    const wantedSet = new Set((metro[nv] || [villeParam]).map(normalize));

    const cards = Array.from(document.querySelectorAll('.post-card'));
    let visible = 0;

    cards.forEach((card) => {
      const ville = normalize(card.getAttribute('data-ville'));
      const tags = (card.getAttribute('data-tags') || '')
        .split(',')
        .map((t) => normalize(t));

      const match =
        wantedSet.has(ville) ||
        tags.some((t) => wantedSet.has(t));

      card.style.display = match ? '' : 'none';
      if (match) visible++;
    });

    // État vide
    const empty = document.getElementById('empty-state');
    const emptyCity = document.getElementById('empty-city');
    if (empty && emptyCity) {
      if (visible === 0) {
        emptyCity.textContent = villeParam;
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
      }
    }

    // Badge “filtre actif”
    const chip = document.getElementById('active-filter');
    const chipLabel = document.getElementById('active-filter-label');
    if (chip && chipLabel) {
      chipLabel.textContent = `Filtre: ${villeParam}`;
      chip.classList.remove('hidden');
    }

    // Title dynamique pour le SEO UX (non bloquant SEO statique)
    const baseTitle = document.title.replace(/\s*\|\s*$/, '');
    document.title = `Articles à ${villeParam} | ${baseTitle}`;
  })();
</script>
