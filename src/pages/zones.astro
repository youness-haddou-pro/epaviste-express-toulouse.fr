---
import Layout from '../layouts/Layout.astro';
import MobileCTA from '../components/MobileCTA.astro';
import ZoneSection from '../components/Zone.astro';
import Contact from '../components/Contact.astro';
import { data } from '../data/siteData';

// 1) Source des villes centralisée (+ fallback compat zoneCities)
const cities =
  (data as any).cities?.length ? (data as any).cities :
  (data as any).zoneCities?.length ? (data as any).zoneCities : [];

// Pour maintenir la compat avec <ZoneSection /> qui lit data.zoneCities
const dataForZone = { ...data, zoneCities: cities };

// 2) Limiter l'affichage à 60 avec bouton Voir tout
const MAX_CITIES_DISPLAY = 60;
const visibleCities = cities.slice(0, MAX_CITIES_DISPLAY);
const hiddenCities = cities.slice(MAX_CITIES_DISPLAY);

// 3) Méta + JSON-LD
const title = `Zones d’intervention – Toulouse + 100 km (gratuit) | ${data.name}`;
const description =
  "Enlèvement d’épaves gratuit à Toulouse et jusqu’à 100 km : Haute-Garonne et villes voisines (Montauban, Albi, Auch, Castres, Foix, Carcassonne, Cahors…).";

const jsonld = {
  '@context': 'https://schema.org',
  '@type': 'AutoWrecker',
  name: data.name,
  url: (data as any).canonical ?? 'https://epaviste-express-toulouse.fr/',
  telephone: data.phoneCompact,
  areaServed: [
    { '@type': 'AdministrativeArea', name: 'Occitanie' },
    ...cities.map((c: string) => ({ '@type': 'City', name: c })),
  ],
  serviceArea: {
    '@type': 'GeoCircle',
    geoMidpoint: { '@type': 'GeoCoordinates', latitude: 43.6045, longitude: 1.444 },
    geoRadius: 100000,
  },
  address: {
    '@type': 'PostalAddress',
    streetAddress: data.address.street,
    postalCode: data.address.postalCode,
    addressLocality: data.address.city,
    addressRegion: data.address.region,
    addressCountry: data.address.country ?? 'FR',
  },
};

// 4) Proximité & repères (UI)
const proches = [
  'Toulouse', 'Colomiers', 'Blagnac', 'Tournefeuille', 'Cugnaux', 'Muret',
  'Balma', 'Ramonville', 'Saint-Orens', 'Plaisance-du-Touch', "L'Union",
  'Castelginest', 'Portet-sur-Garonne', 'Grenade', 'Léguevin',
];

const perimetre = [
  { ville: 'Montauban', approxKm: 46 },
  { ville: 'Albi', approxKm: 66 },
  { ville: 'Castres', approxKm: 70 },
  { ville: 'Auch', approxKm: 64 },
  { ville: 'Foix', approxKm: 67 },
  { ville: 'Carcassonne', approxKm: 85 },
  { ville: 'Cahors', approxKm: 92 },
];
---

<Layout title={title} description={description} jsonld={jsonld} lang="fr">
  <MobileCTA phoneCompact={data.phoneCompact} />

  <!-- Fil d’Ariane -->
  <nav class="mx-auto max-w-6xl px-6 pt-6 text-sm text-gray-700">
    <a href="/" class="rounded-lg px-2 py-1 ring-1 ring-gray-300 transition hover:bg-gray-100">Accueil</a>
    <span aria-hidden="true"> / </span>
    <span class="px-2 py-1 text-gray-500">Zones</span>
  </nav>

  <!-- Hero -->
  <section class="relative mx-auto max-w-6xl px-6 pb-4 pt-10">
    <div class="pointer-events-none absolute inset-x-0 top-0 -z-10 h-28 bg-gradient-to-b from-emerald-100/60 to-transparent opacity-70"></div>
    <header class="reveal" style="--delay:0ms">
      <h1 class="text-3xl font-bold tracking-tight md:text-4xl">Zones d’intervention</h1>
      <p class="mt-3 max-w-3xl text-zinc-600">
        Nous intervenons à <strong>Toulouse</strong> et jusqu’à <strong>100&nbsp;km autour</strong>, gratuitement.
        Au-delà du rayon, l’enlèvement reste possible <em>sur devis</em>.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href={`tel:${data.phoneCompact}`} class="inline-flex items-center gap-2 rounded-2xl bg-emerald-600 px-5 py-2.5 font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
          Appeler {data.phone}
        </a>
        <a href="/services/" class="inline-flex items-center gap-2 rounded-2xl bg-white px-5 py-2.5 font-semibold text-gray-900 ring-1 ring-gray-300 transition hover:-translate-y-0.5 hover:bg-gray-50">
          Voir nos services
        </a>
      </div>
    </header>
  </section>

  <!-- Cartouche marketing -->
  <ZoneSection data={dataForZone} />

  <!-- Grille des villes proches -->
  <section class="reveal mx-auto max-w-6xl px-6 py-12" style="--delay:120ms">
    <h2 class="text-2xl font-bold tracking-tight md:text-3xl">Autour de Toulouse (proximité)</h2>
    <p class="mt-2 text-zinc-600">Intervention gratuite sur ces communes et l’ensemble de l’agglomération toulousaine.</p>
    <ul class="mt-6 grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      {proches.map((v) => (
        <li class="group relative overflow-hidden rounded-xl bg-white px-4 py-2 text-sm ring-1 ring-gray-200 transition hover:shadow-md">
          <a href={`/blog/?ville=${encodeURIComponent(v)}`} class="absolute inset-0" aria-label={`Articles liés à ${v}`}></a>
          <span class="relative z-10">{v}</span>
          <div class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" style="background: radial-gradient(280px circle at var(--x,50%) var(--y,50%), rgba(16,185,129,.08), transparent 40%);"></div>
        </li>
      ))}
    </ul>
  </section>

  <!-- Villes repères à ~100 km -->
  <section class="reveal mx-auto max-w-6xl px-6 pb-4" style="--delay:160ms">
    <h2 class="text-2xl font-bold tracking-tight md:text-3xl">Jusqu’à 100 km</h2>
    <p class="mt-2 text-zinc-600">Quelques villes repères situées dans le rayon gratuit :</p>
    <div class="mt-6 overflow-hidden rounded-2xl bg-white ring-1 ring-gray-200">
      <table class="w-full text-left text-sm">
        <thead class="bg-gray-50 text-gray-700">
          <tr>
            <th class="px-4 py-3">Ville</th>
            <th class="px-4 py-3">Distance approx.</th>
            <th class="px-4 py-3">Infos</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {perimetre.map((row) => (
            <tr class="hover:bg-gray-50/60">
              <td class="px-4 py-3 font-medium">{row.ville}</td>
              <td class="px-4 py-3">{row.approxKm} km</td>
              <td class="px-4 py-3">
                <a href={`/blog/?ville=${encodeURIComponent(row.ville)}`} class="rounded-lg px-2 py-1 ring-1 ring-gray-300 transition hover:bg-gray-100">Voir nos conseils à {row.ville}</a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <p class="mt-3 text-xs text-zinc-500">Distances indicatives «&nbsp;à vol d’oiseau&nbsp;». Gratuit jusqu’à 100&nbsp;km, au-delà sur devis.</p>
  </section>

  <!-- Toutes les communes desservies -->
  <section class="reveal mx-auto max-w-6xl px-6 py-12" style="--delay:200ms">
    <h2 class="text-2xl font-bold tracking-tight md:text-3xl">Toutes les communes desservies</h2>
    <p class="mt-2 text-zinc-600">
      Affichage limité à {MAX_CITIES_DISPLAY} communes pour le confort de lecture. Cliquez sur « Voir tout » pour l’ensemble de la liste.
    </p>

    <div class="mt-5">
      <!-- Liste visible -->
      <ul class="grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        {visibleCities.map((v) => (
          <li class="relative rounded-xl bg-white px-3 py-2 text-sm ring-1 ring-gray-200">
            <a href={`/blog/?ville=${encodeURIComponent(v)}`} class="absolute inset-0" aria-label={`Articles liés à ${v}`}></a>
            <span class="relative">{v}</span>
          </li>
        ))}
      </ul>

      <!-- Liste masquée + bouton -->
      {hiddenCities.length > 0 && (
        <>
          <ul id="more-cities-list" style="display:none" class="mt-2 grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
            {hiddenCities.map((v) => (
              <li class="relative rounded-xl bg-white px-3 py-2 text-sm ring-1 ring-gray-200">
                <a href={`/blog/?ville=${encodeURIComponent(v)}`} class="absolute inset-0" aria-label={`Articles liés à ${v}`}></a>
                <span class="relative">{v}</span>
              </li>
            ))}
          </ul>

          <div class="mt-4">
            <button
              id="toggle-cities"
              class="inline-flex items-center gap-2 rounded-2xl bg-white px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-gray-300 transition hover:bg-gray-50"
              aria-expanded="false"
              aria-controls="more-cities-list"
              type="button"
            >
              Voir tout (+{hiddenCities.length})
            </button>
          </div>
        </>
      )}
    </div>
  </section>

  <!-- Bloc SEO éditorial -->
  <section class="reveal mx-auto max-w-6xl px-6 pb-12" style="--delay:240ms">
    <div class="rounded-2xl bg-white p-6 ring-1 ring-gray-200">
      <h2 class="text-xl font-semibold">Départements couverts</h2>
      <p class="mt-2 text-sm text-zinc-600">
        Interventions dans la <strong>Haute-Garonne (31)</strong> et, selon l’adresse, sur les secteurs limitrophes :
        <strong>Tarn (81)</strong>, <strong>Tarn-et-Garonne (82)</strong>, <strong>Gers (32)</strong>, <strong>Ariège (09)</strong>,
        <strong>Aude (11)</strong>, <strong>Lot (46)</strong>.
      </p>
      <p class="mt-2 text-sm text-zinc-600">
        Besoin d’un enlèvement au-delà du périmètre gratuit ? Appelez-nous : nous proposons un devis clair et rapide.
      </p>
    </div>
  </section>

  <Contact data={data} />
</Layout>

<style is:global>
  .reveal { opacity: 0; transform: translateY(8px); transition: opacity .45s ease, transform .45s ease; transition-delay: var(--delay, 0ms); }
  .reveal.is-inview { opacity: 1; transform: translateY(0); }
  @media (prefers-reduced-motion: reduce) { .reveal { opacity: 1; transform: none; transition: none; } }
</style>

<script>
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('is-inview'); io.unobserve(e.target); } });
  }, { threshold: 0.18 });
  document.querySelectorAll('.reveal').forEach(el => io.observe(el));

  // petit spotlight sur les items de la grille
  document.querySelectorAll('li.group').forEach((el) => {
    el.addEventListener('mousemove', (e) => {
      const r = el.getBoundingClientRect();
      el.style.setProperty('--x', ((e.clientX - r.left) / r.width) * 100 + '%');
      el.style.setProperty('--y', ((e.clientY - r.top) / r.height) * 100 + '%');
    });
    el.addEventListener('mouseleave', () => { el.style.removeProperty('--x'); el.style.removeProperty('--y'); });
  });

  // Bascule Voir tout / Voir moins
  (function () {
    var btn = document.getElementById('toggle-cities');
    var list = document.getElementById('more-cities-list');
    if (!btn || !list) return;
    var expanded = false;

    function update() {
      list.style.display = expanded ? '' : 'none';
      btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      var hiddenCount = list.querySelectorAll('li').length;
      btn.textContent = expanded ? 'Voir moins' : 'Voir tout (+' + hiddenCount + ')';
    }
    btn.addEventListener('click', function () {
      expanded = !expanded;
      update();
    });
    update();
  })();
</script>
